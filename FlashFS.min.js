let params={PAGE_SIZE:4096,FILE_NAME_LENGTH:16,FILE_SIZE_LENGTH:4,FILE_ADDR_LENGTH:4,BOF_LENGTH:1,EOF_LENGTH:1,HEADER_BYTE:[56,46,53],BOF_BYTE:250,EOF_BYTE:251,flash:void 0,flash_addr:void 0,flash_length:void 0};function FlashFS(a,b,c){params.flash=a,params.flash_addr=b,params.flash_length=c}FlashFS.prototype.b4u32=function(a){return a[3]|a[2]<<8|a[1]<<16|a[0]<<24},FlashFS.prototype.u32b4=function(a){return[255&a>>24,255&a>>16,255&a>>8,255&a>>0]},FlashFS.prototype.check=function(){return!(params.flash.read(3,params.flash_addr)!=params.HEADER_BYTE)},FlashFS.prototype.prepare=function(){return params.flash.write(params.HEADER_BYTE,params.flash_addr),this.check()},FlashFS.prototype.format=function(){for(let a=params.flash_addr;a<params.flash_addr+params.flash_length;a+=params.PAGE_SIZE)params.flash.erasePage(a);return this.prepare()},FlashFS.prototype.list=function(){if(this.check()){let a=params.flash_addr+params.HEADER_BYTE.length,b=[];for(;[params.BOF_BYTE]==params.flash.read(params.BOF_LENGTH,a);){let c={};if(c.bof=a,a+=params.BOF_LENGTH,c.path=E.toString(params.flash.read(params.FILE_NAME_LENGTH,a)).trim(),a+=params.FILE_NAME_LENGTH,c.length=this.b4u32(params.flash.read(params.FILE_SIZE_LENGTH,a)),a+=params.FILE_SIZE_LENGTH,c.addr=this.b4u32(params.flash.read(params.FILE_ADDR_LENGTH,a)),a+=params.FILE_ADDR_LENGTH,[params.EOF_BYTE]==params.flash.read(params.EOF_LENGTH,a))c.eof=a,a+=params.EOF_LENGTH;else throw new Error("FS: file '"+c.path+"' hasn't EOF!");b.push(c)}return b}throw new Error("FS not created yet!")},FlashFS.prototype.openFile=function(a,b){let c=this.list(),d=c.find(b=>b.path.toLowerCase()==a.toLowerCase());switch(b){case"w":if(d)throw new Error("FS: file '"+a+"' already exists! Try another name for write!");if(a.length>params.FILE_NAME_LENGTH)throw new Error("FS: name must be maximum '"+params.FILE_NAME_LENGTH+"' chars!");let e,f,g=a.padEnd(params.FILE_NAME_LENGTH," ");if(0<c.length){let a=c[c.length-1];e=a.eof+params.EOF_LENGTH,f=a.addr}else e=params.flash_addr+params.HEADER_BYTE.length,f=e;let h=e+params.BOF_LENGTH+params.FILE_NAME_LENGTH+params.FILE_SIZE_LENGTH+params.FILE_ADDR_LENGTH+params.EOF_LENGTH;if(h-params.flash_addr>params.PAGE_SIZE-1)throw new Error("FS has maximum files!");if(newAddr=params.flash_addr+(Math.floor((f-params.flash_addr)/params.PAGE_SIZE)+1)*params.PAGE_SIZE,newAddr>=params.flash_length)throw new Error("FS is full!");params.flash.write(params.BOF_BYTE,e),params.flash.write(g,e+params.BOF_LENGTH),params.flash.write(this.u32b4(newAddr),e+params.BOF_LENGTH+params.FILE_NAME_LENGTH+params.FILE_SIZE_LENGTH),params.flash.write(params.EOF_BYTE,e+params.BOF_LENGTH+params.FILE_NAME_LENGTH+params.FILE_SIZE_LENGTH+params.FILE_ADDR_LENGTH);let i={bof:e,addr:newAddr};return new FileFS(this,i,b);case"r":if(d)return new FileFS(this,d,b);throw new Error("FS: file '"+a+"' not exists!");default:throw new Error("FS: mode '"+b+"' is not allowed!");}};function FileFS(a,b,c){this.fs=a,this.fileIndex=b,this.mode=c,this.seekPos=b.addr}FileFS.prototype.pipe=function(a,b){let c=b&&b.chunkSize||32,d=this;setTimeout(function e(){let f;(f=d.read(c))?(a.write(f),setTimeout(e,10)):b&&"function"==typeof b.complete&&b.complete()},10)},FileFS.prototype.seek=function(a){let b=this.seekPos+(a||0);if(b<this.fileIndex.addr||b>this.fs.addr)throw new Error("FS: Wrong position to seek!");return this.seekPos=b},FileFS.prototype.skip=function(a){if(a=a||0,0>a)throw new Error("FS: nBytes should be positive number!");this.seek(a)},FileFS.prototype.read=function(a){let b=this.readBytes(a);return b?E.toString(b):void 0},FileFS.prototype.readBytes=function(a){if("w"==this.mode)throw new Error("FS: Can't read in write mode!");let b=this.fileIndex.addr+this.fileIndex.length,c=b-(this.seekPos+a);if(c=0<c?a:b-this.seekPos,0<c){let a=params.flash.read(c,this.seekPos);return this.seekPos+=c,a}},FileFS.prototype.write=function(a){let b;if(b="object"==typeof a||"string"==typeof a?a.length:1,"r"==this.mode)throw new Error("FS: Can't write in read mode!");if(this.seekPos+b>params.flash_length)throw new Error("FS: Can't write. Not enough free space!");return params.flash.write(a,this.seekPos),this.seekPos+=b,b},FileFS.prototype.close=function(){if("r"!=this.mode){let a=this.seekPos-this.fileIndex.addr;params.flash.write(this.fs.u32b4(a),this.fileIndex.bof+params.BOF_LENGTH+params.FILE_NAME_LENGTH)}},exports=function(a,b,c){return new FlashFS(a,b,c)};
